# nginx Configuration

# Made public for anyone to copy/modify and learn from.
# If you spot any misconfiguration in this file - or anything you think I could be
# doing better - please let me know at: alex@alexhaydock.co.uk. Thanks.

user                                    nginx; # This user is named 'nginx' on Red Hat family distributions like CentOS and 'www-data' on Debian-based distributions.
worker_processes			1;
#worker_priority			15; # Equal to "nice=15". This is to prevent attacks on nginx from bringing down the machine (and/or being used as timing attacks).
error_log				/var/log/nginx/error.log;
pid					/run/nginx.pid;

events {
	worker_connections		512; # Number of connections per worker process
}

http {
	# Keep access logs, but anonymise IPs
	map $remote_addr $ip_anonym1 { default 0.0.0; "~(?P<ip>(\d+)\.(\d+)\.(\d+))\.\d+" $ip; "~(?P<ip>[^:]+:[^:]+):" $ip; } # Grab part of the IP we want to have in the log
	map $remote_addr $ip_anonym2 { default .0; "~(?P<ip>(\d+)\.(\d+)\.(\d+))\.\d+" .0; "~(?P<ip>[^:]+:[^:]+):" ::; } # Return the part that symbolises the anonymised part
	map $ip_anonym1$ip_anonym2 $ip_anonymized { default 0.0.0.0; "~(?P<ip>.*)" $ip; } # Map them back together again
	log_format anonymised '$ip_anonymized - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"'; # Define the IP-'anonymised' logging format
	access_log /var/log/nginx/access.log anonymised; # Use IP-'anonymised' log format for the access log

	# Timeouts to ensure we do not keep connections open longer then necessary to reduce resource usage and deny Slowloris type attacks.
	client_body_timeout		4s; # maximum time between packets the client can pause when sending nginx any data
	client_header_timeout		4s; # maximum time the client has to send the entire header to nginx
	keepalive_timeout		75s; # timeout which a single keep-alive client connection will stay open
	send_timeout			24s; # maximum time between packets nginx is allowed to pause when sending the client data
#	spdy_keepalive_timeout		120s; # inactivity timeout after which the SPDY connection is closed
#	spdy_recv_timeout		4s; # timeout if nginx is currently expecting data from the client but nothing arrives

	# Various options
	charset				utf-8;
	default_type			application/octet-stream;
	gzip				on;
	# gzip_static			off; # If we've precompressed content with an external script. We'd need ".html.gz" files, for example, existing in our directory to use this.
	gzip_proxied			any; # Allows compressed responses for any request even from proxies
	ignore_invalid_headers		on;
	include				/etc/nginx/mime.types;
	index				index.html.en index.html; # Ensure that index.html.en is added to support the structure used in the TorProject mirror site
	keepalive_requests		50;  # Number of requests per connection (does not affect SPDY)
	keepalive_disable		none; # Allow all browsers to use keepalive connections
	max_ranges			1; # Only allow a single range header - for resumed downloads, and to stop large range header DoS attacks
	open_file_cache			max=1000 inactive=2h;
	open_file_cache_errors		on;
	open_file_cache_min_uses	1;
	open_file_cache_valid		1h;
	output_buffers			1 512; # Use one 512k chunk output buffer (only if sendfile is off)
	read_ahead			512K; # Kernel read head set to the output_buffers
	recursive_error_pages		on;
	reset_timedout_connection	on; # Reset timed out connections to free RAM
	sendfile			on;  # On for decent direct disk I/O
	server_tokens			off; # Version number in error pages
	server_name_in_redirect		off; # If off, nginx will use the requested Host header
	source_charset			utf-8; # Same value as "charset"
	tcp_nodelay			on; # Nagle buffering algorithm, used for keepalive only
	tcp_nopush			off;

	# SSL options
	ssl_prefer_server_ciphers	on; # Ensure that my cipher preference list is used and not the client's
	ssl_session_cache		shared:SSL:5m; # Allow reuse of sessions so client doesn't need full handshake for each request. (https://vincent.bernat.im/en/blog/2011-ssl-session-reuse-rfc5077.html)
	ssl_session_timeout		5m; # But also timeout sessions after 5min to ensure forward secrecy.
	ssl_session_tickets		off;
#	ssl_stapling			on; # Must be disabled when using BoringSSL. (https://www.imperialviolet.org/2014/04/19/revchecking.html)
#	ssl_stapling_verify		on; # Must be disabled when using BoringSSL. (https://www.imperialviolet.org/2014/04/19/revchecking.html)

	# Redirect all HTTP requests to HTTPS
	server {
		listen			80 default; # listen on HTTP port for ipv4
		listen			[::]:80 default; # listen on HTTP port for ipv6
		root			/usr/share/nginx/html;
	}
}
